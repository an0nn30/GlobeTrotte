version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:latest-node
      - image: circleci/postgres:latest-postgis
        environment:
          POSTGRES_USER: test
          POSTGRES_DB: test
          POSTGRES_PASSWORD: test

    working_directory: ~/GlobeTrotte

    steps:
      - checkout

      - run: echo 'export CHOOSENIM_NO_ANALYTICS=1' >> $BASH_ENV
      - run: echo 'export PATH=/home/circleci/.nimble/bin:$PATH' >> $BASH_ENV
      - run: echo 'export USER="circleci"' >> $BASH_ENV
      - run: sudo apt-get update
      - run: sudo apt-get install libssl-dev
      - run: sudo npm -g install pnpm
      - run: curl https://nim-lang.org/choosenim/init.sh -sSf | sh
      - run: sudo apt-get install shellcheck
      - run: go get winterdrache.de/goformat/goformat
      - run: cp .circleci/test.config config/psql.config

      # run tests
      - run: ./pleasew --show_all_output gen
      - run: ./pleasew test --nocache --show_all_output
      - run: ./pleasew cover --show_all_output
      - run: bash <(curl -s https://codecov.io/bash)
      - run: ./scripts/leftover.sh
